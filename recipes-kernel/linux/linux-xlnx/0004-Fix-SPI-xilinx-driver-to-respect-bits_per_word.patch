From ec6333b6ea2041ed59ba7fa82d1191e10cac6bde Mon Sep 17 00:00:00 2001
From: Adrian Fiergolski <adrian.fiergolski@cern.ch>
Date: Mon, 13 Feb 2017 16:22:23 +0100
Subject: [PATCH 4/5] Fix SPI xilinx driver to respect bits_per_word.

Signed-off-by: Adrian Fiergolski <adrian.fiergolski@cern.ch>
---
 drivers/spi/spi-xilinx.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/drivers/spi/spi-xilinx.c b/drivers/spi/spi-xilinx.c
index b1659f7..70d18e6 100644
--- a/drivers/spi/spi-xilinx.c
+++ b/drivers/spi/spi-xilinx.c
@@ -125,7 +125,7 @@ static void xspi_read_rx_fifo_##size(struct xilinx_spi *xqspi)		\
 	int count = (xqspi->bytes_to_receive > xqspi->buffer_size) ?	\
 			xqspi->buffer_size : xqspi->bytes_to_receive;	\
 	u32 data;							\
-	for (i = 0; i < count; i += (size/8)) {				\
+	for (i = 0; i < count/sizeof( type ); i++) {		        \
 		data = readl_relaxed(xqspi->regs + XSPI_RXD_OFFSET);	\
 		if (xqspi->rx_ptr)					\
 			((type *)xqspi->rx_ptr)[i] = (type)data;	\
@@ -152,7 +152,7 @@ static void xspi_fill_tx_fifo_##size(struct xilinx_spi *xqspi)		\
 	u32 data = 0;							\
 	for (i = 0; i < count; i += (size/8)) {				\
 		if (xqspi->tx_ptr)					\
-			data = (type)((u8 *)xqspi->tx_ptr)[i];		\
+		  data = * ((type *) ( (u8 *) xqspi->tx_ptr +i));	\
 		writel_relaxed(data, (xqspi->regs + XSPI_TXD_OFFSET));	\
 	}								\
 	xqspi->bytes_to_transfer -= count;				\
@@ -555,7 +555,7 @@ static int xilinx_spi_probe(struct platform_device *pdev)
 	master->transfer_one = xspi_start_transfer;
 	master->prepare_transfer_hardware = xspi_prepare_transfer_hardware;
 	master->unprepare_transfer_hardware = xspi_unprepare_transfer_hardware;
-	master->bits_per_word_mask = SPI_BPW_MASK(8);
+	master->bits_per_word_mask = SPI_BPW_MASK( bits_per_word );
 	master->mode_bits = SPI_CPOL | SPI_CPHA | SPI_CS_HIGH;
 
 	xspi->bytes_per_word = bits_per_word / 8;
-- 
2.9.3

